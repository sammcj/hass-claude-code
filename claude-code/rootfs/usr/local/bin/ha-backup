#!/usr/bin/env bash
set -euo pipefail

# ha-backup: Backup and restore files
#
# Usage:
#   ha-backup <file_path>           - Create backup of file
#   ha-backup list                  - List all backups
#   ha-backup restore <backup_name> - Restore a backup
#   ha-backup clean [days]          - Remove backups older than N days (default 180)

BACKUP_DIR="/config/backups/claude"
RETENTION_DAYS=180

show_help() {
    echo "ha-backup - Backup and restore Home Assistant config files"
    echo ""
    echo "Usage:"
    echo "  ha-backup <file_path>           Create a timestamped backup"
    echo "  ha-backup list                  List all backups"
    echo "  ha-backup restore <backup_name> Restore a specific backup"
    echo "  ha-backup clean [days]          Remove backups older than N days (default: $RETENTION_DAYS)"
    echo ""
    echo "Backups are stored in: $BACKUP_DIR"
    echo ""
    echo "Examples:"
    echo "  ha-backup /config/automations.yaml"
    echo "  ha-backup list"
    echo "  ha-backup restore automations.yaml.2025-01-15_14.backup"
    echo "  ha-backup clean 30"
}

list_backups() {
    echo "Backups in $BACKUP_DIR:"
    echo "==========================================="
    if [[ -d "$BACKUP_DIR" ]] && [[ "$(ls -A "$BACKUP_DIR" 2>/dev/null)" ]]; then
        ls -lah "$BACKUP_DIR" | tail -n +2
        echo ""
        echo "Total: $(find "$BACKUP_DIR" -name "*.backup" -type f 2>/dev/null | wc -l | tr -d ' ') backup(s)"
    else
        echo "(no backups found)"
    fi
}

restore_backup() {
    local backup_name="$1"

    if [[ -z "$backup_name" ]]; then
        echo "Error: Specify backup name to restore"
        echo "Use 'ha-backup list' to see available backups"
        exit 1
    fi

    local backup_path="$BACKUP_DIR/$backup_name"

    if [[ ! -f "$backup_path" ]]; then
        echo "Error: Backup not found: $backup_name"
        echo "Use 'ha-backup list' to see available backups"
        exit 1
    fi

    # Extract original filename (remove timestamp and .backup suffix)
    local original_name
    original_name=$(echo "$backup_name" | sed 's/\.[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}_[0-9]\{2\}\.backup$//')
    local target="/config/$original_name"

    echo "Restoring: $backup_name"
    echo "Target:    $target"
    echo ""

    # Create backup of current file before restoring
    if [[ -f "$target" ]]; then
        local pre_restore_backup
        pre_restore_backup="${target}.pre-restore.$(date +%Y-%m-%d_%H%M%S)"
        cp -p "$target" "$pre_restore_backup"
        echo "Current file backed up to: $pre_restore_backup"
    fi

    cp -p "$backup_path" "$target"
    echo "Restore complete!"
}

clean_backups() {
    local days="${1:-$RETENTION_DAYS}"

    if ! [[ "$days" =~ ^[0-9]+$ ]]; then
        echo "Error: Days must be a number"
        exit 1
    fi

    echo "Removing backups older than $days days..."

    if [[ -d "$BACKUP_DIR" ]]; then
        local deleted
        deleted=$(find "$BACKUP_DIR" -name "*.backup" -type f -mtime +"$days" -delete -print 2>/dev/null | wc -l | tr -d ' ')
        echo "Removed $deleted backup(s)"
    else
        echo "No backup directory found"
    fi
}

create_backup() {
    local file_path="$1"

    # Resolve to absolute path
    if [[ ! "$file_path" = /* ]]; then
        file_path="$(pwd)/$file_path"
    fi

    # Check file exists
    if [[ ! -f "$file_path" ]]; then
        echo "Error: File not found: $file_path"
        exit 1
    fi

    # Create backup directory
    mkdir -p "$BACKUP_DIR"

    # Generate backup filename with timestamp (hourly granularity)
    local filename
    filename=$(basename "$file_path")
    local timestamp
    timestamp=$(date +%Y-%m-%d_%H)
    local backup_file="$BACKUP_DIR/${filename}.${timestamp}.backup"

    # Check if backup already exists for this hour
    if [[ -f "$backup_file" ]]; then
        echo "Backup already exists for this hour: $backup_file"
    else
        cp -p "$file_path" "$backup_file"
        echo "Backup created: $backup_file"
    fi

    # Rotate old backups
    local deleted
    deleted=$(find "$BACKUP_DIR" -name "*.backup" -type f -mtime +$RETENTION_DAYS -delete -print 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$deleted" -gt 0 ]]; then
        echo "Rotated $deleted backup(s) older than $RETENTION_DAYS days"
    fi
}

# Main command routing
case "${1:-}" in
    ""|"-h"|"--help"|"help")
        show_help
        ;;
    "list")
        list_backups
        ;;
    "restore")
        restore_backup "${2:-}"
        ;;
    "clean")
        clean_backups "${2:-}"
        ;;
    *)
        create_backup "$1"
        ;;
esac
